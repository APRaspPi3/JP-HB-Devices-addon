#!/bin/sh
# WebUI icon used from http://icons8.com 

ADDON_NAME=`basename "$0"`

ADDON_DIR=/usr/local/addons/${ADDON_NAME}
WWW_DIR=/etc/config/addons/www/${ADDON_NAME}
PIDFILE=/var/run/$ADDON_NAME.pid
LOGFILE=/var/log/$ADDON_NAME.log
ERRFILE=/var/log/$ADDON_NAME.err
FIRMWARE_DIR=/firmware/rftypes
RC_DIR=/usr/local/etc/config/rc.d
CK_FIRMWARE_FILE=${FIRMWARE_DIR}/hb-uni-sen-cap-moist.xml

case "$1" in
	""|start)
	        if [ ! -f ${ADDON_DIR}/installed ] || [ ! -f ${CK_FIRMWARE_FILE} ]; then
	    	mount -o remount,rw /
		    cd ${ADDON_DIR}
		    cp -a firmware/rftypes/* /firmware/rftypes/
		    cp -ar www/* /www/
		    chown root:root /www/config/img/devices/250/hb-*
		    chmod 755 /www/config/img/devices/250/hb-*
		    chown root:root /www/config/img/devices/50/hb-*
		    chmod 755 /www/config/img/devices/50/hb-*
	    	    
		    DEVICE=hb-uni-senact-4-4
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE

		    DEVICE=hb-uni-sen-press
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE

		    DEVICE=hb-uni-sen-cap-moist
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE

		    DEVICE=hb-uni-sen-dist-us
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE

		    DEVICE=hb-uni-sen-lev-us
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE

		    DEVICE=hb-uni-sen-temp
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE

		    DEVICE=hb-uni-sen-wea
		    echo "Installing ${DEVICE}"
		    echo $!> $PIDFILE & ./install_${DEVICE} > $LOGFILE 2>$ERRFILE
		    sync
		    mount -o remount,ro /
		    touch ${ADDON_DIR}/installed
		    /etc/init.d/S61rfd restart
		else
		   echo "Addon already installed - nothing to do"
		fi
	;;

	stop)
		echo "Nothing to stop..."
	;;

	uninstall)
		mount -o remount,rw /
    	cd ${ADDON_DIR}
		DEVICE=hb-uni-senact-4-4
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
		DEVICE=hb-uni-sen-press
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
		DEVICE=hb-uni-sen-cap-moist
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
		DEVICE=hb-uni-sen-dist-us
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
		DEVICE=hb-uni-sen-lev-us
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
		DEVICE=hb-uni-sen-temp
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
		DEVICE=hb-uni-sen-wea
		echo "Uninstalling... ${DEVICE}"
    		echo $!> $PIDFILE & ./uninstall_${DEVICE} > $LOGFILE 2>$ERRFILE
    		echo "Done."
    		cd /
    		rm -rf $ADDON_DIR
    		rm -rf $WWW_DIR
		rm -f ${RC_DIR}/${ADDON_NAME}
    		sync
    		mount -o remount,ro /
    	;;
  
	restart|reload)
  	  # Operations to stop and start (restart) the addon
  	  stop
  	  sleep 2
  	  start
    	;;

	info)
	  echo "Info: <center><b>JP HB Devices Support Addon</b></center><br />" 
	  echo "Info: <center><img src='../addons/${ADDON_NAME}/${ADDON_NAME}.png'></img></center><br/><a href='https://github.com/jp112sdl/${ADDON_NAME}'>https://github.com/jp112sdl/${ADDON_NAME}</a>" 
	  echo "Version: $(cat ${ADDON_DIR}/VERSION)"                                                                                                                                                                                       
	  echo "Name: JP HB Devices"                                                                                                                                                                                                        
	  echo "Operations: uninstall"                                                                                                                                                                                                      
	  #echo "Config-Url: ${CONFIG_URL}"                                                                                                                                                                                                 
	  echo "Update: /addons/${ADDON_NAME}/update-check.cgi"
	;;
	
	*)
		echo "Usage: $ADDON_NAME {start|stop|restart|info|uninstall}" >&2
		exit 1
    	;;

esac

exit $?
